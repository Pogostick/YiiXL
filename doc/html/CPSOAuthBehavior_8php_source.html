<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>&quot;The Yii Extension Library Of Doom!&quot;: /usr/local/yiixl/lib/original/behaviors/CPSOAuthBehavior.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>/usr/local/yiixl/lib/original/behaviors/CPSOAuthBehavior.php</h1>  </div>
</div>
<div class="contents">
<a href="CPSOAuthBehavior_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00027"></a><a class="code" href="classCPSOAuthBehavior.html">00027</a> <span class="keyword">class </span><a class="code" href="classCPSOAuthBehavior.html">CPSOAuthBehavior</a> <span class="keyword">extends</span> <a class="code" href="classCPSApiBehavior.html">CPSApiBehavior</a>
<a name="l00028"></a>00028 {
<a name="l00029"></a>00029     <span class="comment">//********************************************************************************</span>
<a name="l00030"></a>00030     <span class="comment">//* Constants</span>
<a name="l00031"></a>00031     <span class="comment">//********************************************************************************</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033     <span class="comment">/***</span>
<a name="l00034"></a>00034 <span class="comment">    * Our OAuth object</span>
<a name="l00035"></a>00035 <span class="comment">    * @var OAuth</span>
<a name="l00036"></a>00036 <span class="comment">    */</span>
<a name="l00037"></a><a class="code" href="classCPSOAuthBehavior.html#a22b5346078092b10841a52e5cc930862">00037</a>     <span class="keyword">protected</span> <a class="code" href="classCPSOAuthBehavior.html#a22b5346078092b10841a52e5cc930862">$m_oOAuth</a> = null;
<a name="l00038"></a>00038     
<a name="l00043"></a><a class="code" href="classCPSOAuthBehavior.html#a69e9bc86943e578be80bb4319e3b7b61">00043</a>     <span class="keyword">protected</span> <a class="code" href="classCPSOAuthBehavior.html#a69e9bc86943e578be80bb4319e3b7b61">$m_arCurToken</a> = null;
<a name="l00044"></a>00044     
<a name="l00045"></a>00045     <span class="comment">//********************************************************************************</span>
<a name="l00046"></a>00046     <span class="comment">//* Properties</span>
<a name="l00047"></a>00047     <span class="comment">//********************************************************************************</span>
<a name="l00048"></a>00048 
<a name="l00053"></a><a class="code" href="classCPSOAuthBehavior.html#a211a2979c22afcd7d9056a2bb55aa449">00053</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#a211a2979c22afcd7d9056a2bb55aa449">getToken</a>() { <span class="keywordflow">return</span> $this-&gt;m_arCurToken; }
<a name="l00054"></a>00054 
<a name="l00059"></a><a class="code" href="classCPSOAuthBehavior.html#a13fb41e10ef1a77aacb14d33ac1ce1be">00059</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#a13fb41e10ef1a77aacb14d33ac1ce1be">getOAuthObject</a>() { <span class="keywordflow">return</span> $this-&gt;m_oOAuth; }
<a name="l00060"></a>00060     
<a name="l00061"></a>00061     <span class="comment">//********************************************************************************</span>
<a name="l00062"></a>00062     <span class="comment">//* Constructor</span>
<a name="l00063"></a>00063     <span class="comment">//********************************************************************************</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065     <span class="comment">/***</span>
<a name="l00066"></a>00066 <span class="comment">    * Constructor</span>
<a name="l00067"></a>00067 <span class="comment">    *</span>
<a name="l00068"></a>00068 <span class="comment">    */</span>
<a name="l00069"></a><a class="code" href="classCPSOAuthBehavior.html#a095c5d389db211932136b53f25f39685">00069</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#a095c5d389db211932136b53f25f39685">__construct</a>()
<a name="l00070"></a>00070     {
<a name="l00071"></a>00071         <span class="comment">//  No oauth? No run...</span>
<a name="l00072"></a>00072         <span class="keywordflow">if</span> ( ! extension_loaded( <span class="stringliteral">&#39;oauth&#39;</span> ) )
<a name="l00073"></a>00073             <span class="keywordflow">throw</span> <span class="keyword">new</span> CException( Yii::t( <span class="stringliteral">&#39;psOAuthBehavior&#39;</span>, <span class="stringliteral">&#39;The &quot;oauth&quot; extension is not loaded. Please install and/or load the oath extension (PECL).&#39;</span> ) );
<a name="l00074"></a>00074         
<a name="l00075"></a>00075         <span class="comment">//  Call daddy...</span>
<a name="l00076"></a>00076         <a class="code" href="classCPSOAuthBehavior.html#a095c5d389db211932136b53f25f39685">parent::__construct</a>();
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078     
<a name="l00079"></a>00079     <span class="comment">//********************************************************************************</span>
<a name="l00080"></a>00080     <span class="comment">//* Public Methods</span>
<a name="l00081"></a>00081     <span class="comment">//********************************************************************************</span>
<a name="l00082"></a>00082                                      
<a name="l00086"></a><a class="code" href="classCPSOAuthBehavior.html#a2dc262e99b1c246b56f27626bfe699ff">00086</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#a2dc262e99b1c246b56f27626bfe699ff">preinit</a>()
<a name="l00087"></a>00087     {
<a name="l00088"></a>00088         <a class="code" href="classCPSOAuthBehavior.html#a2dc262e99b1c246b56f27626bfe699ff">parent::preinit</a>();
<a name="l00089"></a>00089         
<a name="l00090"></a>00090         <span class="comment">//  Add our options</span>
<a name="l00091"></a>00091         $this-&gt;<a class="code" href="interfaceIPSOptionContainer.html#a81e3f5a80b8819b6b35f788ea02c1be5">addOptions</a>( self::getBaseOptions() );
<a name="l00092"></a>00092         
<a name="l00093"></a>00093         <span class="comment">//  Events...</span>
<a name="l00094"></a>00094         $this-&gt;attachEventHandler( <span class="stringliteral">&#39;onUserAuthorized&#39;</span>, <a class="code" href="admin_8php.html#a2394bd91cde70158acb50a4a7f860ab5">array</a>( $this, <span class="stringliteral">&#39;userAuthorized&#39;</span> ) );
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096         
<a name="l00101"></a><a class="code" href="classCPSOAuthBehavior.html#a4be4055f3361d4800e16bc2e2e38cda6">00101</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#a4be4055f3361d4800e16bc2e2e38cda6">init</a>()
<a name="l00102"></a>00102     {
<a name="l00103"></a>00103         <span class="comment">//  Create our object...        </span>
<a name="l00104"></a>00104         $this-&gt;m_oOAuth = <span class="keyword">new</span> OAuth( $this-&gt;apiKey, $this-&gt;apiSecretKey, OAUTH_SIG_METHOD_HMACSHA1, OAUTH_AUTH_TYPE_URI );
<a name="l00105"></a>00105 
<a name="l00106"></a>00106         <span class="comment">//  Load any tokens we have...</span>
<a name="l00107"></a>00107         $this-&gt;<a class="code" href="classCPSOAuthBehavior.html#a5126349c471fcaff1a74b9d117b979b1">loadToken</a>();
<a name="l00108"></a>00108         
<a name="l00109"></a>00109         <span class="comment">//  Have we been authenticated?</span>
<a name="l00110"></a>00110         <span class="keywordflow">if</span> ( ! $this-&gt;isAuthorized )
<a name="l00111"></a>00111         {
<a name="l00112"></a>00112             <span class="keywordflow">if</span> ( isset( $_REQUEST[ <span class="stringliteral">&#39;oauth_token&#39;</span> ] ) )
<a name="l00113"></a>00113             {
<a name="l00114"></a>00114                 <span class="keywordflow">if</span> ( $this-&gt;m_oOAuth-&gt;setToken( $_REQUEST[ <span class="stringliteral">&#39;oauth_token&#39;</span> ], $_REQUEST[ <span class="stringliteral">&#39;oauth_verifier&#39;</span> ] ) )
<a name="l00115"></a>00115                 {
<a name="l00116"></a>00116                     $_arToken = $this-&gt;m_oOAuth-&gt;getAccessToken( $this-&gt;apiBaseUrl . $this-&gt;accessTokenUrl, null, $_REQUEST[ <span class="stringliteral">&#39;oauth_verifier&#39;</span> ] );
<a name="l00117"></a>00117                     $this-&gt;<a class="code" href="classCPSOAuthBehavior.html#ab53bf3a3bd85d4b1bef5f84fd9b1527c">storeToken</a>( $_arToken );
<a name="l00118"></a>00118                     $this-&gt;isAuthorized = <span class="keyword">true</span>;
<a name="l00119"></a>00119                 }
<a name="l00120"></a>00120                 
<a name="l00121"></a>00121                 <span class="comment">//  Raise our event</span>
<a name="l00122"></a>00122                 <span class="keywordflow">if</span> ( $this-&gt;isAuthorized )
<a name="l00123"></a>00123                     $this-&gt;<a class="code" href="classCPSOAuthBehavior.html#aa2ddabcd9b27c0cec44f886ea1ded176">onUserAuthorized</a>( <span class="keyword">new</span> <a class="code" href="classCPSOAuthEvent.html">CPSOAuthEvent</a>( $this-&gt;m_arCurToken ) );
<a name="l00124"></a>00124             }
<a name="l00125"></a>00125         }
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127     
<a name="l00133"></a><a class="code" href="classCPSOAuthBehavior.html#a94d630cf8cc55a8a7929862d81e3a6ab">00133</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#a94d630cf8cc55a8a7929862d81e3a6ab">getAuthorizeUrl</a>()
<a name="l00134"></a>00134     {
<a name="l00135"></a>00135         $_arToken = $this-&gt;m_oOAuth-&gt;getRequestToken( $this-&gt;apiBaseUrl . $this-&gt;requestTokenUrl, $this-&gt;callbackUrl );
<a name="l00136"></a>00136         <span class="keywordflow">return</span> $this-&gt;apiBaseUrl . $this-&gt;authorizeUrl . <span class="stringliteral">&#39;?oauth_token=&#39;</span> . $_arToken[ <span class="stringliteral">&#39;oauth_token&#39;</span> ];
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138     
<a name="l00144"></a><a class="code" href="classCPSOAuthBehavior.html#ab53bf3a3bd85d4b1bef5f84fd9b1527c">00144</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#ab53bf3a3bd85d4b1bef5f84fd9b1527c">storeToken</a>( $oToken = <a class="code" href="admin_8php.html#a2394bd91cde70158acb50a4a7f860ab5">array</a>() )
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         <span class="keywordflow">try</span>
<a name="l00147"></a>00147         {
<a name="l00148"></a>00148             Yii::app()-&gt;user-&gt;setState( $this-&gt;<a class="code" href="interfaceIPSComponent.html#aa18c8754403c04289ac8fbfc467df4ac">getInternalName</a>() . <span class="stringliteral">&#39;_oAuthToken&#39;</span>, $oToken );
<a name="l00149"></a>00149             Yii::app()-&gt;user-&gt;setState( $this-&gt;<a class="code" href="interfaceIPSComponent.html#aa18c8754403c04289ac8fbfc467df4ac">getInternalName</a>() . <span class="stringliteral">&#39;_isAuthorized&#39;</span>, $this-&gt;isAuthorized );
<a name="l00150"></a>00150             $this-&gt;m_arCurToken = $oToken;
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152         <span class="keywordflow">catch</span> ( Exception $_ex )
<a name="l00153"></a>00153         {
<a name="l00154"></a>00154             $_sName = $this-&gt;<a class="code" href="interfaceIPSComponent.html#aa18c8754403c04289ac8fbfc467df4ac">getInternalName</a>();
<a name="l00155"></a>00155             <a class="code" href="classCPSLog.html#a99034739d5e469b037364bf2f5694e11">CPSLog::error</a>( <span class="stringliteral">&#39;pogostick.behaviors&#39;</span>, Yii::t( $_sName, <span class="stringliteral">&#39;Error storing OAuth token &quot;{a}/{b}&quot; : {c}&#39;</span>, <a class="code" href="admin_8php.html#a2394bd91cde70158acb50a4a7f860ab5">array</a>( <span class="stringliteral">&quot;{a}&quot;</span> =&gt; $oToken[<span class="stringliteral">&#39;oauth_token&#39;</span>], <span class="stringliteral">&quot;{b}&quot;</span> =&gt; $oToken[<span class="stringliteral">&#39;oauth_token_secret&#39;</span>], <span class="stringliteral">&quot;{c}&quot;</span> =&gt; $_ex-&gt;getMessage() ) ) );
<a name="l00156"></a>00156         }
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158 
<a name="l00163"></a><a class="code" href="classCPSOAuthBehavior.html#a5126349c471fcaff1a74b9d117b979b1">00163</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#a5126349c471fcaff1a74b9d117b979b1">loadToken</a>()
<a name="l00164"></a>00164     {
<a name="l00165"></a>00165         $_oUser = Yii::app()-&gt;user;
<a name="l00166"></a>00166         
<a name="l00167"></a>00167         <span class="keywordflow">if</span> ( $_oUser )
<a name="l00168"></a>00168         {
<a name="l00169"></a>00169             <span class="keywordflow">if</span> ( null != ( $_oToken = $_oUser-&gt;getState( $this-&gt;getInternalName() . <span class="stringliteral">&#39;_oAuthToken&#39;</span> ) ) )
<a name="l00170"></a>00170             {
<a name="l00171"></a>00171                 $this-&gt;m_arCurToken = $_oToken;
<a name="l00172"></a>00172                 $this-&gt;isAuthorized = ( $_oUser-&gt;getState( $this-&gt;<a class="code" href="interfaceIPSComponent.html#aa18c8754403c04289ac8fbfc467df4ac">getInternalName</a>() . <span class="stringliteral">&#39;_isAuthorized&#39;</span> ) == true );
<a name="l00173"></a>00173             }
<a name="l00174"></a>00174             <span class="keywordflow">else</span>
<a name="l00175"></a>00175                 $_oToken = <a class="code" href="admin_8php.html#a2394bd91cde70158acb50a4a7f860ab5">array</a>();
<a name="l00176"></a>00176         }
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="comment">//********************************************************************************</span>
<a name="l00180"></a>00180     <span class="comment">//* Private Methods</span>
<a name="l00181"></a>00181     <span class="comment">//********************************************************************************</span>
<a name="l00182"></a>00182     
<a name="l00186"></a>00186     <span class="keyword">private</span> function getBaseOptions()
<a name="l00187"></a>00187     {
<a name="l00188"></a>00188         <span class="keywordflow">return</span>(
<a name="l00189"></a>00189             <a class="code" href="admin_8php.html#a2394bd91cde70158acb50a4a7f860ab5">array</a>(
<a name="l00190"></a>00190                 <span class="comment">//  Required settings</span>
<a name="l00191"></a>00191                 <span class="stringliteral">&#39;callbackUrl&#39;</span> =&gt; <span class="stringliteral">&#39;string&#39;</span>,
<a name="l00192"></a>00192                 <span class="stringliteral">&#39;isAuthorized&#39;</span> =&gt; <span class="stringliteral">&#39;boolean:false&#39;</span>,
<a name="l00193"></a>00193                 
<a name="l00194"></a>00194                 <span class="comment">//  Urls</span>
<a name="l00195"></a>00195                 <span class="stringliteral">&#39;accessTokenUrl&#39;</span> =&gt; <span class="stringliteral">&#39;string:/oauth/access_token&#39;</span>,
<a name="l00196"></a>00196                 <span class="stringliteral">&#39;authorizeUrl&#39;</span> =&gt; <span class="stringliteral">&#39;string:/oauth/authorize&#39;</span>, 
<a name="l00197"></a>00197                 <span class="stringliteral">&#39;requestTokenUrl&#39;</span> =&gt; <span class="stringliteral">&#39;string:/oauth/request_token&#39;</span>, 
<a name="l00198"></a>00198             )
<a name="l00199"></a>00199         );
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="comment">//********************************************************************************</span>
<a name="l00203"></a>00203     <span class="comment">//* Events</span>
<a name="l00204"></a>00204     <span class="comment">//********************************************************************************</span>
<a name="l00205"></a>00205     
<a name="l00206"></a>00206     <span class="comment">/***</span>
<a name="l00207"></a>00207 <span class="comment">     * User has been authorized event</span>
<a name="l00208"></a>00208 <span class="comment">     * @param CPSOAuthEvent $oEvent</span>
<a name="l00209"></a>00209 <span class="comment">     */</span>
<a name="l00210"></a><a class="code" href="classCPSOAuthBehavior.html#aa2ddabcd9b27c0cec44f886ea1ded176">00210</a>     <span class="keyword">public</span> function <a class="code" href="classCPSOAuthBehavior.html#aa2ddabcd9b27c0cec44f886ea1ded176">onUserAuthorized</a>( $oEvent )
<a name="l00211"></a>00211     {
<a name="l00212"></a>00212         $this-&gt;raiseEvent( <span class="stringliteral">&#39;onUserAuthorized&#39;</span>, $oEvent );
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214     
<a name="l00215"></a>00215 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Mar 24 2011 20:11:38 for "The Yii Extension Library Of Doom!" by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
